var HDRImage=function(){function t(){var t,e,i=document.createElement("canvas"),o="t",h=1,s=2.2,u=null;return i.__defineGetter__("exposure",function(){return h}),i.__defineSetter__("exposure",function(a){h=a,u&&(r(u,h,s,e.data),t.putImageData(e,0,0))}),i.__defineGetter__("gamma",function(){return s}),i.__defineSetter__("gamma",function(a){s=a,u&&(r(u,h,s,e.data),t.putImageData(e,0,0))}),i.__defineGetter__("dataFloat",function(){return n(u)}),i.__defineGetter__("dataRGBE",function(){return u}),i.toHDRDataURL=function(){t&&t.clearRect(0,0,this.width,this.height),e.data.set(u),t.globalCompositeOperation="copy",t.putImageData(e,0,0);var a=this.toDataURL();return r(u,h,s,e.data),t.putImageData(e,0,0),a},i.toHDRBlob=function(a,n,i){e.data.set(u),t.globalCompositeOperation="copy",t.putImageData(e,0,0),this.toBlob(function(n){r(u,h,s,e.data),t.putImageData(e,0,0),a(n)},n,i)},i.__defineGetter__("src",function(){return o}),i.__defineSetter__("src",function(n){if(o=n,t&&t.clearRect(0,0,this.width,this.height),n.match(/\.hdr$/i))a(n,function(a,n,i){u=a,this.width=this.style.width=n,this.height=this.style.height=i,t=this.getContext("2d"),e=t.getImageData(0,0,n,i),r(a,h,s,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(i));else if(n.match(/\.hdr\.png$/i)){var f=new Image;f.src=n,f.onload=function(){this.width=this.style.width=f.width,this.height=this.style.height=f.height,t=this.getContext("2d"),t.globalCompositeOperation="copy",t.drawImage(f,0,0),e=t.getImageData(0,0,this.width,this.height),u=new Uint8Array(e.data),r(u,h,s,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(this)}}),i}function e(t,e){for(var a in e)t[a]=e[a];return t}function a(t,a){var n=e(new XMLHttpRequest,{responseType:"arraybuffer"});return n.onerror=a.bind(n,!1),n.onload=function(){if(this.status>=400)return this.onerror();for(var t,e="",n=0,r=new Uint8Array(this.response);!e.match(/\n\n[^\n]+\n/g);)e+=String.fromCharCode(r[n++]);if(t=e.match(/FORMAT=(.*)$/m)[1],"32-bit_rle_rgbe"!=t)return console.warn("unknown format : "+t),this.onerror();for(var i=e.split(/\n/).reverse()[1].split(" "),o=1*i[3],h=1*i[1],s=new Uint8Array(o*h*4),u=0,f=0;h>f;f++){var d=r.slice(n,n+=4),c=[];if(2!=d[0]||2!=d[1]||128&d[2])return console.warn("HDR parse error .."),this.onerror();if((d[2]<<8)+d[3]!=o)return console.warn("HDR line mismatch .."),this.onerror();for(var l=0;4>l;l++)for(var g,p,_=l*o,m=(l+1)*o;m>_;)if(g=r.slice(n,n+=2),g[0]>128)for(p=g[0]-128;p-->0;)c[_++]=g[1];else for(p=g[0]-1,c[_++]=g[1];p-->0;)c[_++]=r[n++];for(var l=0;o>l;l++)s[u++]=c[l],s[u++]=c[l+o],s[u++]=c[l+2*o],s[u++]=c[l+3*o]}a&&a(s,o,h)},n.open("GET",t,!0),n.send(null),n}function n(t,e){for(var a,n=t.byteLength>>2,e=e||new Float32Array(3*n),r=0;n>r;r++)a=Math.pow(2,t[4*r+3]-136),e[3*r]=t[4*r]*a,e[3*r+1]=t[4*r+1]*a,e[3*r+2]=t[4*r+2]*a;return e}function r(t,e,a,n){e=Math.pow(2,void 0===e?1:e)/2,void 0===a&&(a=2.2);for(var r,i=1/a,o=t.byteLength>>2,n=n||new Uint8ClampedArray(4*o),h=0;o>h;h++)r=e*Math.pow(2,t[4*h+3]-136),n[4*h]=255*Math.pow(t[4*h]*r,i),n[4*h+1]=255*Math.pow(t[4*h+1]*r,i),n[4*h+2]=255*Math.pow(t[4*h+2]*r,i),n[4*h+3]=255;return n}return t}();