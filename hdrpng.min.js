var HDRImage=function(){function t(){var t,e,i=document.createElement("canvas"),o="t",h=1,s=2.2,u=null;return i.__defineGetter__("exposure",function(){return h}),i.__defineSetter__("exposure",function(r){h=r,u&&(a(u,h,s,e.data),t.putImageData(e,0,0))}),i.__defineGetter__("gamma",function(){return s}),i.__defineSetter__("gamma",function(r){s=r,u&&(a(u,h,s,e.data),t.putImageData(e,0,0))}),i.__defineGetter__("dataFloat",function(){return n(u)}),i.__defineGetter__("dataRGBE",function(){return u}),i.toHDRDataURL=function(){t&&t.clearRect(0,0,this.width,this.height),e.data.set(u),t.globalCompositeOperation="copy",t.putImageData(e,0,0);var r=this.toDataURL();return a(u,h,s,e.data),t.putImageData(e,0,0),r},i.__defineGetter__("src",function(){return o}),i.__defineSetter__("src",function(n){if(o=n,t&&t.clearRect(0,0,this.width,this.height),n.match(/\.hdr$/i))r(n,function(r,n,i){u=r,this.width=this.style.width=n,this.height=this.style.height=i,t=this.getContext("2d"),e=t.getImageData(0,0,n,i),a(r,h,s,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(i));else if(n.match(/\.hdr\.png$/i)){var f=new Image;f.src=n,f.onload=function(){this.width=this.style.width=f.width,this.height=this.style.height=f.height,t=this.getContext("2d"),t.globalCompositeOperation="copy",t.drawImage(f,0,0),e=t.getImageData(0,0,this.width,this.height),u=new Uint8Array(e.data),a(u,h,s,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(this)}}),i}function e(t,e){for(var r in e)t[r]=e[r];return t}function r(t,r){var n=e(new XMLHttpRequest,{responseType:"arraybuffer"});return n.onerror=r.bind(n,!1),n.onload=function(){if(this.status>=400)return this.onerror();for(var t,e="",n=0,a=new Uint8Array(this.response);!e.match(/\n\n[^\n]+\n/g);)e+=String.fromCharCode(a[n++]);if(t=e.match(/FORMAT=(.*)$/m)[1],"32-bit_rle_rgbe"!=t)return console.warn("unknown format : "+t),this.onerror();for(var i=e.split(/\n/).reverse()[1].split(" "),o=1*i[3],h=1*i[1],s=new Uint8Array(o*h*4),u=0,f=0;h>f;f++){var d=a.slice(n,n+=4),c=[];if(2!=d[0]||2!=d[1]||128&d[2])return console.warn("HDR parse error .."),this.onerror();if((d[2]<<8)+d[3]!=o)return console.warn("HDR line mismatch .."),this.onerror();for(var l=0;4>l;l++)for(var _,g,p=l*o,m=(l+1)*o;m>p;)if(_=a.slice(n,n+=2),_[0]>128)for(g=_[0]-128;g-->0;)c[p++]=_[1];else for(g=_[0]-1,c[p++]=_[1];g-->0;)c[p++]=a[n++];for(var l=0;o>l;l++)s[u++]=c[l],s[u++]=c[l+o],s[u++]=c[l+2*o],s[u++]=c[l+3*o]}r&&r(s,o,h)},n.open("GET",t,!0),n.send(null),n}function n(t,e){for(var r,n=t.byteLength>>2,e=e||new Float32Array(3*n),a=0;n>a;a++)r=Math.pow(2,t[4*a+3]-136),e[3*a]=t[4*a]*r,e[3*a+1]=t[4*a+1]*r,e[3*a+2]=t[4*a+2]*r;return e}function a(t,e,r,n){e=Math.pow(2,void 0===e?1:e)/2,void 0===r&&(r=2.2);for(var a,i=1/r,o=t.byteLength>>2,n=n||new Uint8ClampedArray(4*o),h=0;o>h;h++)a=e*Math.pow(2,t[4*h+3]-136),n[4*h]=255*Math.pow(t[4*h]*a,i),n[4*h+1]=255*Math.pow(t[4*h+1]*a,i),n[4*h+2]=255*Math.pow(t[4*h+2]*a,i),n[4*h+3]=255;return n}return t}();
