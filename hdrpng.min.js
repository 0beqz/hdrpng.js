/* hdrpng.js - by enki - https://enkimute.github.io */
!function(t,e,n){"undefined"!=typeof module&&module.exports?module.exports=n():"function"==typeof define&&define.amd?define(t,n):e[t]=n()}("HDRImage",this,function(){function t(){var t,e,a=document.createElement("canvas"),s="t",u=1,h=2.2,f=null;return a.__defineGetter__("exposure",function(){return u}),a.__defineSetter__("exposure",function(n){u=n,f&&(i(f,u,h,e.data),t.putImageData(e,0,0))}),a.__defineGetter__("gamma",function(){return h}),a.__defineSetter__("gamma",function(n){h=n,f&&(i(f,u,h,e.data),t.putImageData(e,0,0))}),a.__defineGetter__("dataFloat",function(){return o(f)}),a.__defineGetter__("dataRGBE",function(){return f}),a.toHDRDataURL=function(){t&&t.clearRect(0,0,this.width,this.height),e.data.set(f),t.globalCompositeOperation="copy",t.putImageData(e,0,0);var n=this.toDataURL();return i(f,u,h,e.data),t.putImageData(e,0,0),n},a.toHDRBlob=function(n,r,o){e.data.set(f),t.globalCompositeOperation="copy",t.putImageData(e,0,0),this.toBlob(function(r){i(f,u,h,e.data),t.putImageData(e,0,0),n(r)},r,o)},a.__defineGetter__("src",function(){return s}),a.__defineSetter__("src",function(o){if(s=o,t&&t.clearRect(0,0,this.width,this.height),o.match(/\.hdr$/i))r(o,function(n,r,o){f=n,this.width=this.style.width=r,this.height=this.style.height=o,t=this.getContext("2d"),e=t.getImageData(0,0,r,o),i(n,u,h,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(a));else if(o.match(/\.exr$/i))n(o,function(t,e,n){console.log("exr load : ",t,e,n),this.onload&&this.onload()}.bind(a));else if(o.match(/\.hdr\.png$/i)){var l=new Image;l.src=o,l.onload=function(){this.width=this.style.width=l.width,this.height=this.style.height=l.height,t=this.getContext("2d"),t.globalCompositeOperation="copy",t.drawImage(l,0,0),e=t.getImageData(0,0,this.width,this.height),f=new Uint8Array(e.data),i(f,u,h,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(this)}}),a}function e(t,e){for(var n in e)t[n]=e[n];return t}function n(t,n){var r=e(new XMLHttpRequest,{responseType:"arraybuffer"});return r.onerror=n.bind(r,!1),r.onload=function(){function t(){return(a[i++]<<0)+(a[i++]<<8)+(a[i++]<<16)+(a[i++]<<24)}function e(){return(a[i++]<<0)+(a[i++]<<8)+(a[i++]<<16)}function r(){return a[i++]}function o(){for(var t,e="";t=r();)e+=String.fromCharCode(t);return e}var i=0,a=new Uint8Array(this.response);if(20000630!=t())return console.log("EXR invalid"),this.onerror();if(r()>2)return console.log("EXR unsupported version"),this.onerror();if(0!=e())return console.log("EXR only simple files .."),this.onerror();if("channels"!=o()||"chlist"!=o())return console.log("EXR invalid headers"),this.onerror();for(var s=[],u=t()+i;u-1>i;)s.push({name:o(),type:t(),u0:r(),u1:e(),u2:t(),u2:t()});return r(),"compression"!=o()||"compression"!=o()?(console.log("EXR only simple files .."),this.onerror()):(console.log(t(),r()),t(),r()?(console.log("EXR compression not supported"),this.onerror()):void(n&&n()))},r.open("GET",t,!0),r.send(null),r}function r(t,n){var r=e(new XMLHttpRequest,{responseType:"arraybuffer"});return r.onerror=n.bind(r,!1),r.onload=function(){if(this.status>=400)return this.onerror();for(var t,e="",r=0,o=new Uint8Array(this.response);!e.match(/\n\n[^\n]+\n/g);)e+=String.fromCharCode(o[r++]);if(t=e.match(/FORMAT=(.*)$/m)[1],"32-bit_rle_rgbe"!=t)return console.warn("unknown format : "+t),this.onerror();for(var i=e.split(/\n/).reverse()[1].split(" "),a=1*i[3],s=1*i[1],u=new Uint8Array(a*s*4),h=0,f=0;s>f;f++){var l=o.slice(r,r+=4),d=[];if(2!=l[0]||2!=l[1]||128&l[2])return console.warn("HDR parse error .."),this.onerror();if((l[2]<<8)+l[3]!=a)return console.warn("HDR line mismatch .."),this.onerror();for(var c=0;4>c;c++)for(var p,g,m=c*a,_=(c+1)*a;_>m;)if(p=o.slice(r,r+=2),p[0]>128)for(g=p[0]-128;g-->0;)d[m++]=p[1];else for(g=p[0]-1,d[m++]=p[1];g-->0;)d[m++]=o[r++];for(var c=0;a>c;c++)u[h++]=d[c],u[h++]=d[c+a],u[h++]=d[c+2*a],u[h++]=d[c+3*a]}n&&n(u,a,s)},r.open("GET",t,!0),r.send(null),r}function o(t,e){for(var n,r=t.byteLength>>2,e=e||new Float32Array(3*r),o=0;r>o;o++)n=Math.pow(2,t[4*o+3]-136),e[3*o]=t[4*o]*n,e[3*o+1]=t[4*o+1]*n,e[3*o+2]=t[4*o+2]*n;return e}function i(t,e,n,r){e=Math.pow(2,void 0===e?1:e)/2,void 0===n&&(n=2.2);for(var o,i=1/n,a=t.byteLength>>2,r=r||new Uint8ClampedArray(4*a),s=0;a>s;s++)o=e*Math.pow(2,t[4*s+3]-136),r[4*s]=255*Math.pow(t[4*s]*o,i),r[4*s+1]=255*Math.pow(t[4*s+1]*o,i),r[4*s+2]=255*Math.pow(t[4*s+2]*o,i),r[4*s+3]=255;return r}return t});